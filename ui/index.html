<!DOCTYPE html>
<html lang="fr" data-theme="ptcg-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon TCG Tracker</title>
    <link href="vendor/daisyui.min.css" rel="stylesheet">
    <script src="vendor/tailwind.min.js"></script>
    <script src="vendor/chart.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen">

    <!-- Navbar fixe -->
    <nav class="navbar fixed top-0 z-10 h-12 px-4 bg-base-200 border-b border-base-300">
        <div class="flex flex-1 gap-1">
            <button class="tab tab-active" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="history">Historique</button>
            <button class="tab" data-tab="decks">Decks</button>
            <button class="tab" data-tab="config">Config</button>
        </div>
        <!-- Bouton ajout match -->
        <button class="btn btn-primary btn-sm mr-2"
                onclick="matchForm.open()"
                title="Ajouter un match manuellement">
            + Match
        </button>
        <!-- Toggle th√®me -->
        <label class="swap swap-rotate cursor-pointer" title="Basculer le th√®me">
            <input id="theme-toggle" type="checkbox">
            <span class="swap-on text-lg">‚òÄÔ∏è</span>
            <span class="swap-off text-lg">üåô</span>
        </label>
    </nav>

    <!-- Contenu principal -->
    <main class="pt-14 max-w-[1100px] mx-auto px-4">

        <!-- Onglet Dashboard -->
        <section id="tab-dashboard">
            <div class="flex justify-between items-center mt-4 mb-2">
                <h2 class="text-xl font-semibold">Dashboard</h2>
                <select id="season-filter" data-season-filter="1"
                        class="select select-sm select-bordered min-w-[180px]">
                    <option value="">Toutes les saisons</option>
                </select>
            </div>
            <div class="kpi-row"><!-- stats-bar.js --></div>
            <div class="charts-row"><!-- chart-winrate.js --></div>
            <div class="table-section"><!-- match-table.js --></div>
        </section>

        <!-- Onglet Historique -->
        <section id="tab-history" class="hidden mt-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Historique</h2>
                <div class="flex gap-2 items-center">
                    <select data-season-filter="1"
                            class="select select-sm select-bordered min-w-[160px]">
                        <option value="">Toutes les saisons</option>
                    </select>
                    <button class="btn btn-sm btn-outline"
                            onclick="window.dispatchEvent(new CustomEvent('export-csv-requested'))">
                        Exporter CSV
                    </button>
                </div>
            </div>
            <p id="export-error" class="text-error text-sm mb-2" style="display:none;"></p>
            <!-- match-table.js -->
        </section>

        <!-- Onglet Decks -->
        <section id="tab-decks" class="hidden mt-4">
            <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-base-300">Mes Decks</h2>

            <div class="flex gap-2 mb-4">
                <input id="deck-name-input"
                       type="text"
                       placeholder="Nom du deck"
                       maxlength="100"
                       class="input input-bordered flex-1 max-w-xs">
                <button id="deck-create-btn" class="btn btn-primary">Cr√©er</button>
            </div>
            <p id="deck-form-error" class="text-error text-sm mb-3" style="display:none;"></p>

            <div id="decks-list"></div>
        </section>

        <!-- Onglet Config -->
        <section id="tab-config" class="hidden mt-4">
            <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-base-300">Configuration</h2>

            <!-- R√©gion MUMU -->
            <div class="bg-base-200 rounded-box p-4 mb-4 border border-base-300">
                <h3 class="text-xs font-semibold uppercase tracking-wide opacity-60 mb-3">R√©gion MUMU</h3>
                <div id="config-region-display" class="font-mono text-sm opacity-70 mb-2"></div>
                <button id="config-region-select-btn" class="btn btn-sm btn-outline">
                    Configurer la r√©gion MUMU
                </button>
                <p id="config-status" class="text-success text-sm mt-2" style="display:none;"></p>
            </div>

            <!-- Deck actif -->
            <div class="bg-base-200 rounded-box p-4 mb-4 border border-base-300">
                <h3 class="text-xs font-semibold uppercase tracking-wide opacity-60 mb-3">Deck actif</h3>
                <label for="active-deck-select" class="text-sm block mb-2">
                    Deck utilis√© pour la prochaine session :
                </label>
                <select id="active-deck-select" class="select select-bordered select-sm w-full max-w-xs">
                    <option value="">‚Äî Aucun deck actif ‚Äî</option>
                </select>
                <p id="active-deck-confirm" class="text-success text-sm mt-2" style="display:none;"></p>
            </div>

            <!-- Avertissement r√©gion non configur√©e -->
            <p id="region-required-hint"
               class="text-sm mb-3 p-3 rounded-box border border-base-300 opacity-70"
               style="display:none;">
                Configurez la r√©gion MUMU ci-dessus pour activer la capture et la calibration.
            </p>

            <!-- Test capture -->
            <div class="bg-base-200 rounded-box p-4 mb-4 border border-base-300">
                <h3 class="text-xs font-semibold uppercase tracking-wide opacity-60 mb-3">
                    Test de capture en direct
                </h3>
                <p id="capture-status-text" class="text-sm opacity-70 mb-2"></p>
                <button id="capture-test-btn" class="btn btn-sm btn-outline">Tester la capture</button>
                <p id="capture-error" class="text-error text-sm mt-2" style="display:none;"></p>
                <img id="capture-preview"
                     alt="Aper√ßu capture MUMU"
                     style="display:none; max-width:100%; margin-top:8px; border-radius:8px;">
            </div>

            <!-- Calibration d√©tecteur -->
            <div class="bg-base-200 rounded-box p-4 border border-base-300">
                <h3 class="text-xs font-semibold uppercase tracking-wide opacity-60 mb-3">
                    Calibration du d√©tecteur d'√©tat
                </h3>
                <p class="text-sm opacity-70 mb-3">
                    Pour chaque √©tat, lancez le jeu dans cet √©tat et cliquez "Calibrer".
                    Le d√©tecteur comparera les captures suivantes √† ces r√©f√©rences.
                </p>
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Pr√©-queue ranked</span>
                        <div class="flex items-center gap-3">
                            <span id="cal-status-pre_queue" class="text-xs"></span>
                            <button class="btn btn-sm btn-outline"
                                    onclick="app_calibrate('pre_queue')" class="btn btn-sm btn-outline btn-calibrate">Calibrer</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">En combat</span>
                        <div class="flex items-center gap-3">
                            <span id="cal-status-in_combat" class="text-xs"></span>
                            <button class="btn btn-sm btn-outline"
                                    onclick="app_calibrate('in_combat')" class="btn btn-sm btn-outline btn-calibrate">Calibrer</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Fin de match</span>
                        <div class="flex items-center gap-3">
                            <span id="cal-status-end_screen" class="text-xs"></span>
                            <button class="btn btn-sm btn-outline"
                                    onclick="app_calibrate('end_screen')" class="btn btn-sm btn-outline btn-calibrate">Calibrer</button>
                        </div>
                    </div>
                </div>
                <p id="cal-error"   class="text-error   text-sm mt-3" style="display:none;"></p>
                <p id="cal-success" class="text-success text-sm mt-3" style="display:none;"></p>
            </div>
        </section>

    </main>

    <!-- Detail Panel (slide-in depuis droite) -->
    <aside id="detail-panel" class="detail-panel"></aside>

    <!-- Modal saisie manuelle de match -->
    <dialog id="match-form-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Ajouter un match</h3>
            <div class="flex flex-col gap-3">

                <div class="form-control">
                    <label class="label"><span class="label-text">R√©sultat</span></label>
                    <select id="mf-result" class="select select-bordered">
                        <option value="W">Victoire (W)</option>
                        <option value="L">D√©faite (L)</option>
                        <option value="D">Nul (D)</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Deck jou√©</span></label>
                    <select id="mf-deck" class="select select-bordered">
                        <option value="">‚Äî Aucun ‚Äî</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Adversaire (deck)</span></label>
                    <input id="mf-opponent" type="text" placeholder="ex: Charizard ex"
                           class="input input-bordered" maxlength="100">
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Premier √† jouer</span></label>
                    <select id="mf-first" class="select select-bordered">
                        <option value="?">Inconnu</option>
                        <option value="Moi">Moi</option>
                        <option value="Adversaire">Adversaire</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Saison (optionnel)</span></label>
                    <input id="mf-season" type="text" placeholder="ex: 2025-A1"
                           class="input input-bordered" maxlength="50">
                </div>

                <p id="mf-error" class="text-error text-sm" style="display:none;"></p>
            </div>

            <div class="modal-action">
                <button class="btn btn-ghost"
                        onclick="document.getElementById('match-form-modal').close()">
                    Annuler
                </button>
                <button class="btn btn-primary" id="mf-submit">Enregistrer</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>Fermer</button></form>
    </dialog>

    <!-- Banni√®re mise √† jour disponible -->
    <div id="update-banner" style="display:none;"
         class="fixed top-12 left-0 right-0 z-40 bg-base-300 border-b border-base-300 px-4 py-2 flex items-center gap-3 text-sm">
        <span id="update-banner-text"></span>
        <button class="btn btn-xs btn-primary"
                onclick="window.dispatchEvent(new CustomEvent('open-url-requested'))">
            T√©l√©charger
        </button>
        <button class="btn btn-xs btn-ghost ml-auto"
                onclick="document.getElementById('update-banner').style.display='none'">‚úï</button>
    </div>

    <!-- Toast notifications -->
    <div id="toast-container"
         class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 min-w-[220px]"></div>

    <!-- Scripts -->
    <script src="components/deck-manager.js"></script>
    <script src="components/config-manager.js"></script>
    <script src="components/capture-test.js"></script>
    <script src="components/active-deck-selector.js"></script>
    <script src="components/stats-bar.js"></script>
    <script src="components/chart-winrate.js"></script>
    <script src="components/chart-trend.js"></script>
    <script src="components/chart-opponents.js"></script>
    <script src="components/match-table.js"></script>
    <script src="components/detail-panel.js"></script>
    <script src="components/match-form.js"></script>
    <script src="app.js"></script>
</body>
</html>
